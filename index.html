<!DOCTYPE html>
<html lang="en-NZ">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NZ Tax Invoice Generator</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        h2 {
            color: #555;
            margin-top: 25px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #007bff;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }

        input, textarea, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #007bff;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }

        button:hover {
            background: #0056b3;
        }

        button.secondary {
            background: #6c757d;
        }

        button.secondary:hover {
            background: #545b62;
        }

        button.danger {
            background: #dc3545;
        }

        button.danger:hover {
            background: #c82333;
        }

        button.success {
            background: #28a745;
        }

        button.success:hover {
            background: #218838;
        }

        .invoice-items {
            margin: 20px 0;
        }

        .invoice-item {
            display: grid;
            grid-template-columns: auto 3fr 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: end;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .invoice-item.hourly {
            grid-template-columns: auto 1fr 3fr 1fr 1fr 1fr auto;
        }

        .invoice-item .form-group.hidden {
            display: none;
        }

        .invoice-item button {
            padding: 10px 15px;
        }

        .totals {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .totals-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 16px;
        }

        .totals-row.total {
            font-weight: bold;
            font-size: 20px;
            border-top: 2px solid #333;
            padding-top: 12px;
            margin-top: 8px;
        }

        .client-select {
            margin-bottom: 20px;
        }

        .client-select select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
        }

        /* Invoice Preview Styles */
        .invoice-preview {
            display: none;
            margin-top: 30px;
            padding: 40px;
            background: white;
            border: 1px solid #ddd;
        }

        .invoice-preview.active {
            display: block;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #333;
        }

        .invoice-title {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }

        .invoice-details {
            text-align: right;
        }

        .from-to {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 30px;
        }

        .from-section, .to-section {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .section-title {
            font-weight: bold;
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin: 30px 0;
        }

        .invoice-table th {
            background: #333;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .invoice-table td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        .invoice-table tr:last-child td {
            border-bottom: none;
        }

        .invoice-table .text-right {
            text-align: right;
        }

        .invoice-totals {
            margin-left: auto;
            width: 300px;
            margin-top: 20px;
        }

        .bank-details {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                padding: 0;
            }

            h1, h2, .form-grid, .form-group, .button-group, .client-select, .invoice-items, .totals, .gst-option, button, p {
                display: none !important;
            }

            .invoice-preview {
                display: block !important;
                border: none;
                padding: 20px;
            }
        }

        .optional-label {
            color: #999;
            font-size: 12px;
            font-weight: normal;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #007bff;
        }

        .modal-header h2 {
            margin: 0;
            border: none;
            padding: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 35px;
            height: 35px;
            line-height: 35px;
            text-align: center;
            border-radius: 50%;
            transition: background 0.3s, color 0.3s;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .modal-section {
            margin-bottom: 20px;
        }

        .modal-section h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .modal-section p, .modal-section ul {
            color: #555;
            line-height: 1.8;
            margin-bottom: 10px;
        }

        .modal-section ul {
            padding-left: 20px;
        }

        .modal-section li {
            margin-bottom: 8px;
        }

        .about-button {
            background: #6c757d;
            margin-left: auto;
        }

        .about-button:hover {
            background: #545b62;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h1 style="margin: 0;">NZ Tax Invoice Generator</h1>
            <button class="about-button" onclick="openAboutModal()">About</button>
        </div>

        <!-- Trader Details Section -->
        <h2>Your Business Details</h2>
        <div class="form-grid">
            <div class="form-group">
                <label for="traderName">Business/Trading Name *</label>
                <input type="text" id="traderName" required>
            </div>
            <div class="form-group">
                <label for="traderGST">GST Number <span class="optional-label">(optional)</span></label>
                <input type="text" id="traderGST" placeholder="e.g., 123-456-789">
            </div>
            <div class="form-group">
                <label for="traderEmail">Email *</label>
                <input type="email" id="traderEmail" required>
            </div>
            <div class="form-group">
                <label for="traderPhone">Phone</label>
                <input type="tel" id="traderPhone">
            </div>
        </div>
        <div class="form-group">
            <label for="traderAddress">Address *</label>
            <textarea id="traderAddress" required></textarea>
        </div>

        <h2>Bank Account Details</h2>
        <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
            <strong>Important:</strong> NZ banks now verify that the account name matches the account number. Please ensure your account name is exactly as it appears with your bank.
        </p>
        <div class="form-grid">
            <div class="form-group">
                <label for="traderBankName">Bank Name *</label>
                <input type="text" id="traderBankName" placeholder="e.g., ANZ, ASB, BNZ, Westpac" required>
            </div>
            <div class="form-group">
                <label for="traderAccountName">Account Name *</label>
                <input type="text" id="traderAccountName" placeholder="Name as it appears on your bank account" required>
            </div>
            <div class="form-group">
                <label for="traderAccountNumber">Account Number *</label>
                <input type="text" id="traderAccountNumber" placeholder="XX-XXXX-XXXXXXX-XX" required>
            </div>
        </div>
        <div class="button-group">
            <button onclick="saveTraderDetails()">Save My Details</button>
            <button class="secondary" onclick="clearTraderDetails()">Clear</button>
        </div>

        <!-- Client Selection -->
        <h2>Select or Add Client</h2>
        <div class="client-select">
            <select id="clientSelect" onchange="loadSelectedClient()">
                <option value="">-- Select a saved client or add new below --</option>
            </select>
        </div>

        <!-- Client Details Section -->
        <h2>Client Details</h2>
        <div class="form-grid">
            <div class="form-group">
                <label for="clientName">Client Name *</label>
                <input type="text" id="clientName" required>
            </div>
            <div class="form-group">
                <label for="clientEmail">Email</label>
                <input type="email" id="clientEmail">
            </div>
            <div class="form-group">
                <label for="clientPhone">Phone</label>
                <input type="tel" id="clientPhone">
            </div>
        </div>
        <div class="form-group">
            <label for="clientAddress">Address *</label>
            <textarea id="clientAddress" required></textarea>
        </div>
        <div class="button-group">
            <button onclick="saveClient()">Save Client</button>
            <button class="secondary" onclick="clearClientDetails()">Clear</button>
            <button class="danger" onclick="deleteClient()">Delete Selected Client</button>
        </div>

        <!-- Invoice Details -->
        <h2>Invoice Details</h2>
        <div class="form-grid">
            <div class="form-group">
                <label for="invoiceNumber">Invoice Number *</label>
                <input type="text" id="invoiceNumber" required>
            </div>
            <div class="form-group">
                <label for="invoiceDate">Invoice Date *</label>
                <input type="date" id="invoiceDate" required>
            </div>
            <div class="form-group">
                <label for="dueDate">Due Date</label>
                <input type="date" id="dueDate">
            </div>
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label for="periodStart">Invoice Period Start <span class="optional-label">(optional)</span></label>
                <input type="date" id="periodStart">
            </div>
            <div class="form-group">
                <label for="periodEnd">Invoice Period End <span class="optional-label">(optional)</span></label>
                <input type="date" id="periodEnd">
            </div>
        </div>

        <!-- Invoice Items -->
        <h2>Invoice Items</h2>
        <div class="invoice-items" id="invoiceItems">
            <!-- Items will be added here dynamically -->
        </div>
        <button onclick="addInvoiceItem()">+ Add Item</button>

        <!-- GST Option -->
        <div class="gst-option" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 4px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="includeGST" onchange="saveGSTPreference(); calculateTotals();" checked style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">Include GST (15%)</span>
            </label>
            <p style="margin: 8px 0 0 28px; font-size: 13px; color: #666;">
                Uncheck this if you are not GST-registered or if this invoice is GST-exempt
            </p>
        </div>

        <!-- Totals -->
        <div class="totals">
            <div class="totals-row">
                <span id="subtotalLabel">Subtotal (excl. GST):</span>
                <span id="subtotal">$0.00</span>
            </div>
            <div class="totals-row" id="gstRow">
                <span>GST (15%):</span>
                <span id="gstAmount">$0.00</span>
            </div>
            <div class="totals-row total">
                <span id="totalLabel">Total (incl. GST):</span>
                <span id="total">$0.00</span>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="button-group">
            <button class="success" onclick="generateInvoice()">Generate Invoice</button>
            <button onclick="printInvoice()">Print Invoice</button>
            <button class="secondary" onclick="resetForm()">Reset Form</button>
        </div>

        <!-- Invoice Preview -->
        <div class="invoice-preview" id="invoicePreview">
            <!-- Invoice will be rendered here -->
        </div>
    </div>

    <!-- About Modal -->
    <div id="aboutModal" class="modal" onclick="closeAboutModalOnBackdrop(event)">
        <div class="modal-content">
            <div class="modal-header">
                <h2>About NZ Tax Invoice Generator</h2>
                <button class="modal-close" onclick="closeAboutModal()" aria-label="Close">&times;</button>
            </div>
            
            <div class="modal-section">
                <h3>What is this app?</h3>
                <p>NZ Tax Invoice Generator is a free, easy-to-use tool for creating professional tax invoices that comply with New Zealand GST requirements. All your data is stored locally in your browser—nothing is sent to any server.</p>
            </div>

            <div class="modal-section">
                <h3>Key Features</h3>
                <ul>
                    <li><strong>Save Your Details:</strong> Store your business and bank account information for quick reuse</li>
                    <li><strong>Client Management:</strong> Save multiple clients and select them from a dropdown</li>
                    <li><strong>Flexible Invoicing:</strong> Support for both generic items and hourly rate billing</li>
                    <li><strong>GST Options:</strong> Toggle GST on/off depending on your registration status</li>
                    <li><strong>Professional Output:</strong> Generate print-ready invoices with all required information</li>
                    <li><strong>Local Storage:</strong> All data is stored in your browser using cookies—no server required</li>
                </ul>
            </div>

            <div class="modal-section">
                <h3>How to Use</h3>
                <p><strong>First Time Setup:</strong></p>
                <ol style="padding-left: 20px; line-height: 1.8;">
                    <li>Fill in your business details including bank account information</li>
                    <li>Click "Save My Details" to store your information</li>
                    <li>Add client details and click "Save Client"</li>
                </ol>
                <p><strong>Creating an Invoice:</strong></p>
                <ol style="padding-left: 20px; line-height: 1.8;">
                    <li>Select a saved client or enter new client details</li>
                    <li>Verify the invoice number and date (auto-generated)</li>
                    <li>Add invoice items using the "+ Add Item" button</li>
                    <li>Toggle GST inclusion if needed (enabled by default)</li>
                    <li>Click "Generate Invoice" to preview</li>
                    <li>Click "Print Invoice" to print or save as PDF</li>
                </ol>
            </div>

            <div class="modal-section">
                <h3>Data Storage</h3>
                <p>This app stores all your information locally in your browser using cookies. Your data never leaves your computer. The stored information includes:</p>
                <ul>
                    <li>Your business details and bank account information</li>
                    <li>Saved client information</li>
                    <li>GST preference</li>
                    <li>Last invoice number</li>
                </ul>
                <p><strong>Note:</strong> If you clear your browser cookies, all stored data will be lost.</p>
            </div>

            <div class="modal-section">
                <h3>Bank Account Verification</h3>
                <p>New Zealand banks now verify that the account name matches the account number. Please ensure your account name is entered exactly as it appears with your bank to avoid payment issues.</p>
            </div>
        </div>
    </div>

    <script>
        // Cookie functions
        function setCookie(name, value, days = 365) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = "expires=" + date.toUTCString();
            document.cookie = name + "=" + encodeURIComponent(JSON.stringify(value)) + ";" + expires + ";path=/";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) {
                    try {
                        return JSON.parse(decodeURIComponent(c.substring(nameEQ.length, c.length)));
                    } catch (e) {
                        return null;
                    }
                }
            }
            return null;
        }

        // Initialize
        let invoiceItemCount = 0;
        let clients = getCookie('nz_invoice_clients') || [];

        // Load saved data on page load
        window.onload = function() {
            loadTraderDetails();
            loadClients();
            loadGSTPreference();
            addInvoiceItem(); // Add first item - this will call calculateTotals()
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoiceDate').value = today;
            
            // Generate next invoice number
            const lastInvoiceNum = getCookie('nz_invoice_last_number') || 0;
            document.getElementById('invoiceNumber').value = 'INV-' + String(parseInt(lastInvoiceNum) + 1).padStart(4, '0');
        };

        // GST Preference Functions
        function saveGSTPreference() {
            const includeGST = document.getElementById('includeGST').checked;
            setCookie('nz_invoice_include_gst', includeGST);
        }

        function loadGSTPreference() {
            const includeGST = getCookie('nz_invoice_include_gst');
            // If preference exists, use it; otherwise default to true (checked)
            if (includeGST !== null) {
                document.getElementById('includeGST').checked = includeGST;
            }
            // Note: calculateTotals() will be called by addInvoiceItem() after this
        }

        // Trader Details Functions
        function saveTraderDetails() {
            const trader = {
                name: document.getElementById('traderName').value,
                gst: document.getElementById('traderGST').value,
                email: document.getElementById('traderEmail').value,
                phone: document.getElementById('traderPhone').value,
                address: document.getElementById('traderAddress').value,
                accountName: document.getElementById('traderAccountName').value,
                bankName: document.getElementById('traderBankName').value,
                accountNumber: document.getElementById('traderAccountNumber').value
            };

            if (!trader.name || !trader.email || !trader.address || !trader.accountName || !trader.bankName || !trader.accountNumber) {
                alert('Please fill in all required fields (marked with *)');
                return;
            }

            setCookie('nz_invoice_trader', trader);
            alert('Your business details have been saved!');
        }

        function loadTraderDetails() {
            const trader = getCookie('nz_invoice_trader');
            if (trader) {
                document.getElementById('traderName').value = trader.name || '';
                document.getElementById('traderGST').value = trader.gst || '';
                document.getElementById('traderEmail').value = trader.email || '';
                document.getElementById('traderPhone').value = trader.phone || '';
                document.getElementById('traderAddress').value = trader.address || '';
                document.getElementById('traderAccountName').value = trader.accountName || '';
                document.getElementById('traderBankName').value = trader.bankName || '';
                document.getElementById('traderAccountNumber').value = trader.accountNumber || '';
            }
        }

        function clearTraderDetails() {
            if (confirm('Are you sure you want to clear your business details?')) {
                document.getElementById('traderName').value = '';
                document.getElementById('traderGST').value = '';
                document.getElementById('traderEmail').value = '';
                document.getElementById('traderPhone').value = '';
                document.getElementById('traderAddress').value = '';
                document.getElementById('traderAccountName').value = '';
                document.getElementById('traderBankName').value = '';
                document.getElementById('traderAccountNumber').value = '';
            }
        }

        // Client Functions
        function loadClients() {
            const select = document.getElementById('clientSelect');
            select.innerHTML = '<option value="">-- Select a saved client or add new below --</option>';
            
            clients.forEach((client, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = client.name;
                select.appendChild(option);
            });
        }

        function loadSelectedClient() {
            const select = document.getElementById('clientSelect');
            const index = select.value;
            
            if (index === '') {
                clearClientDetails();
                return;
            }

            const client = clients[index];
            document.getElementById('clientName').value = client.name || '';
            document.getElementById('clientEmail').value = client.email || '';
            document.getElementById('clientPhone').value = client.phone || '';
            document.getElementById('clientAddress').value = client.address || '';
        }

        function saveClient() {
            const client = {
                name: document.getElementById('clientName').value,
                email: document.getElementById('clientEmail').value,
                phone: document.getElementById('clientPhone').value,
                address: document.getElementById('clientAddress').value
            };

            if (!client.name || !client.address) {
                alert('Please fill in at least Client Name and Address');
                return;
            }

            // Check if client already exists
            const existingIndex = clients.findIndex(c => c.name === client.name);
            
            if (existingIndex !== -1) {
                if (confirm('A client with this name already exists. Update their details?')) {
                    clients[existingIndex] = client;
                } else {
                    return;
                }
            } else {
                clients.push(client);
            }

            setCookie('nz_invoice_clients', clients);
            loadClients();
            
            // Select the newly saved/updated client
            const newIndex = clients.findIndex(c => c.name === client.name);
            document.getElementById('clientSelect').value = newIndex;
            
            alert('Client saved successfully!');
        }

        function deleteClient() {
            const select = document.getElementById('clientSelect');
            const index = select.value;
            
            if (index === '') {
                alert('Please select a client to delete');
                return;
            }

            const client = clients[index];
            
            if (confirm(`Are you sure you want to delete client "${client.name}"?`)) {
                clients.splice(index, 1);
                setCookie('nz_invoice_clients', clients);
                loadClients();
                clearClientDetails();
                alert('Client deleted successfully');
            }
        }

        function clearClientDetails() {
            document.getElementById('clientName').value = '';
            document.getElementById('clientEmail').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientAddress').value = '';
            document.getElementById('clientSelect').value = '';
        }

        // Invoice Item Functions
        function addInvoiceItem() {
            const container = document.getElementById('invoiceItems');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'invoice-item';
            itemDiv.id = 'item-' + invoiceItemCount;
            
            itemDiv.innerHTML = `
                <div class="form-group">
                    <label>Type</label>
                    <select class="item-type" onchange="updateItemFields('item-${invoiceItemCount}')">
                        <option value="generic">Generic</option>
                        <option value="hourly">Hourly Rate</option>
                    </select>
                </div>
                <div class="form-group item-date-field hidden">
                    <label>Date</label>
                    <input type="date" class="item-date" onchange="calculateTotals()">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" class="item-description" onchange="calculateTotals()">
                </div>
                <div class="form-group item-quantity-field">
                    <label>Quantity</label>
                    <input type="number" class="item-quantity" value="1" min="0" step="0.01" onchange="calculateTotals()">
                </div>
                <div class="form-group item-hours-field hidden">
                    <label>Hours</label>
                    <input type="number" class="item-hours" value="0" min="0" step="0.25" onchange="calculateTotals()">
                </div>
                <div class="form-group item-rate-field">
                    <label>Unit Price ($)</label>
                    <input type="number" class="item-rate" value="0" min="0" step="0.01" onchange="calculateTotals()">
                </div>
                <div class="form-group">
                    <label>Amount ($)</label>
                    <input type="number" class="item-amount" value="0" readonly>
                </div>
                <button class="danger" onclick="removeInvoiceItem('item-${invoiceItemCount}')">Remove</button>
            `;
            
            container.appendChild(itemDiv);
            invoiceItemCount++;
        }

        function removeInvoiceItem(itemId) {
            const item = document.getElementById(itemId);
            if (item) {
                item.remove();
                calculateTotals();
            }
        }

        function updateItemFields(itemId) {
            const item = document.getElementById(itemId);
            const type = item.querySelector('.item-type').value;
            
            const dateField = item.querySelector('.item-date-field');
            const quantityField = item.querySelector('.item-quantity-field');
            const hoursField = item.querySelector('.item-hours-field');
            const rateField = item.querySelector('.item-rate-field');
            const rateLabel = rateField.querySelector('label');
            
            if (type === 'hourly') {
                // Show hourly fields, hide generic fields
                item.classList.add('hourly');
                dateField.classList.remove('hidden');
                hoursField.classList.remove('hidden');
                quantityField.classList.add('hidden');
                rateLabel.textContent = 'Rate ($)';
                
                // Set default values
                item.querySelector('.item-hours').value = item.querySelector('.item-hours').value || '0';
                if (!item.querySelector('.item-date').value) {
                    item.querySelector('.item-date').value = new Date().toISOString().split('T')[0];
                }
            } else {
                // Show generic fields, hide hourly fields
                item.classList.remove('hourly');
                dateField.classList.add('hidden');
                hoursField.classList.add('hidden');
                quantityField.classList.remove('hidden');
                rateLabel.textContent = 'Unit Price ($)';
                
                // Set default values
                item.querySelector('.item-quantity').value = item.querySelector('.item-quantity').value || '1';
            }
            
            calculateTotals();
        }

        function calculateTotals() {
            const items = document.querySelectorAll('.invoice-item');
            let subtotal = 0;

            items.forEach(item => {
                const type = item.querySelector('.item-type').value;
                let amount = 0;
                
                if (type === 'hourly') {
                    const hours = parseFloat(item.querySelector('.item-hours').value) || 0;
                    const rate = parseFloat(item.querySelector('.item-rate').value) || 0;
                    amount = hours * rate;
                } else {
                    const quantity = parseFloat(item.querySelector('.item-quantity').value) || 0;
                    const rate = parseFloat(item.querySelector('.item-rate').value) || 0;
                    amount = quantity * rate;
                }
                
                item.querySelector('.item-amount').value = amount.toFixed(2);
                subtotal += amount;
            });

            const includeGST = document.getElementById('includeGST').checked;
            const gst = includeGST ? subtotal * 0.15 : 0; // NZ GST is 15%
            const total = subtotal + gst;

            // Update labels and visibility based on GST inclusion
            const gstRow = document.getElementById('gstRow');
            const subtotalLabel = document.getElementById('subtotalLabel');
            const totalLabel = document.getElementById('totalLabel');
            
            if (includeGST) {
                gstRow.style.display = 'flex';
                subtotalLabel.textContent = 'Subtotal (excl. GST):';
                totalLabel.textContent = 'Total (incl. GST):';
            } else {
                gstRow.style.display = 'none';
                subtotalLabel.textContent = 'Subtotal:';
                totalLabel.textContent = 'Total:';
            }

            document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('gstAmount').textContent = '$' + gst.toFixed(2);
            document.getElementById('total').textContent = '$' + total.toFixed(2);
        }

        // Invoice Generation
        function generateInvoice() {
            // Validate required fields
            const trader = {
                name: document.getElementById('traderName').value,
                gst: document.getElementById('traderGST').value,
                email: document.getElementById('traderEmail').value,
                phone: document.getElementById('traderPhone').value,
                address: document.getElementById('traderAddress').value,
                accountName: document.getElementById('traderAccountName').value,
                bankName: document.getElementById('traderBankName').value,
                accountNumber: document.getElementById('traderAccountNumber').value
            };

            const client = {
                name: document.getElementById('clientName').value,
                email: document.getElementById('clientEmail').value,
                phone: document.getElementById('clientPhone').value,
                address: document.getElementById('clientAddress').value
            };

            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const dueDate = document.getElementById('dueDate').value;
            const periodStart = document.getElementById('periodStart').value;
            const periodEnd = document.getElementById('periodEnd').value;

            if (!trader.name || !trader.email || !trader.address || !trader.accountName || !trader.bankName || !trader.accountNumber) {
                alert('Please fill in all required business details, including bank account information');
                return;
            }

            if (!client.name || !client.address) {
                alert('Please fill in required client details');
                return;
            }

            if (!invoiceNumber || !invoiceDate) {
                alert('Please fill in invoice number and date');
                return;
            }

            // Get invoice items
            const items = [];
            document.querySelectorAll('.invoice-item').forEach(item => {
                const type = item.querySelector('.item-type').value;
                const description = item.querySelector('.item-description').value;
                const rate = parseFloat(item.querySelector('.item-rate').value) || 0;
                
                let itemData = { type, description, rate };
                let amount = 0;
                
                if (type === 'hourly') {
                    const date = item.querySelector('.item-date').value;
                    const hours = parseFloat(item.querySelector('.item-hours').value) || 0;
                    amount = hours * rate;
                    itemData = { ...itemData, date, hours, amount };
                    
                    if (description && hours > 0) {
                        items.push(itemData);
                    }
                } else {
                    const quantity = parseFloat(item.querySelector('.item-quantity').value) || 0;
                    amount = quantity * rate;
                    itemData = { ...itemData, quantity, amount };
                    
                    if (description && quantity > 0) {
                        items.push(itemData);
                    }
                }
            });

            if (items.length === 0) {
                alert('Please add at least one invoice item');
                return;
            }

            // Calculate totals
            const includeGST = document.getElementById('includeGST').checked;
            const subtotal = items.reduce((sum, item) => sum + item.amount, 0);
            const gst = includeGST ? subtotal * 0.15 : 0;
            const total = subtotal + gst;

            // Generate invoice HTML
            const invoiceHTML = `
                <div class="invoice-header">
                    <div>
                        <div class="invoice-title">${includeGST ? 'TAX INVOICE' : 'INVOICE'}</div>
                    </div>
                    <div class="invoice-details">
                        <strong>Invoice #:</strong> ${invoiceNumber}<br>
                        <strong>Date:</strong> ${formatDate(invoiceDate)}<br>
                        ${dueDate ? `<strong>Due Date:</strong> ${formatDate(dueDate)}<br>` : ''}
                        ${periodStart || periodEnd ? `<strong>Period:</strong> ${periodStart ? formatDate(periodStart) : ''} ${periodStart && periodEnd ? ' - ' : ''} ${periodEnd ? formatDate(periodEnd) : ''}<br>` : ''}
                    </div>
                </div>

                <div class="from-to">
                    <div class="from-section">
                        <div class="section-title">From</div>
                        <strong>${trader.name}</strong><br>
                        ${trader.address.replace(/\n/g, '<br>')}<br>
                        ${trader.email}<br>
                        ${trader.phone ? trader.phone + '<br>' : ''}
                        ${trader.gst ? '<strong>GST Number:</strong> ' + trader.gst : ''}
                    </div>
                    <div class="to-section">
                        <div class="section-title">Bill To</div>
                        <strong>${client.name}</strong><br>
                        ${client.address.replace(/\n/g, '<br>')}<br>
                        ${client.email ? client.email + '<br>' : ''}
                        ${client.phone ? client.phone : ''}
                    </div>
                </div>

                <table class="invoice-table">
                    <thead>
                        <tr>
                            ${items.some(item => item.type === 'hourly') ? '<th>Date</th>' : ''}
                            <th>Description</th>
                            ${items.some(item => item.type === 'hourly') ? '<th class="text-right">Hours</th>' : ''}
                            ${items.some(item => item.type === 'generic') ? '<th class="text-right">Quantity</th>' : ''}
                            <th class="text-right">${items.some(item => item.type === 'hourly') && items.some(item => item.type === 'generic') ? 'Unit Price/Rate' : items.some(item => item.type === 'hourly') ? 'Rate' : 'Unit Price'}</th>
                            <th class="text-right">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => {
                            if (item.type === 'hourly') {
                                return `
                                    <tr>
                                        <td>${formatDate(item.date)}</td>
                                        <td>${item.description}</td>
                                        <td class="text-right">${item.hours}</td>
                                        ${items.some(i => i.type === 'generic') ? '<td class="text-right">-</td>' : ''}
                                        <td class="text-right">$${item.rate.toFixed(2)}</td>
                                        <td class="text-right">$${item.amount.toFixed(2)}</td>
                                    </tr>
                                `;
                            } else {
                                return `
                                    <tr>
                                        ${items.some(i => i.type === 'hourly') ? '<td>-</td>' : ''}
                                        <td>${item.description}</td>
                                        ${items.some(i => i.type === 'hourly') ? '<td class="text-right">-</td>' : ''}
                                        <td class="text-right">${item.quantity}</td>
                                        <td class="text-right">$${item.rate.toFixed(2)}</td>
                                        <td class="text-right">$${item.amount.toFixed(2)}</td>
                                    </tr>
                                `;
                            }
                        }).join('')}
                    </tbody>
                </table>

                <div class="invoice-totals">
                    <div class="totals-row">
                        <span>${includeGST ? 'Subtotal (excl. GST):' : 'Subtotal:'}</span>
                        <span>$${subtotal.toFixed(2)}</span>
                    </div>
                    ${includeGST ? `
                    <div class="totals-row">
                        <span>GST (15%):</span>
                        <span>$${gst.toFixed(2)}</span>
                    </div>
                    ` : ''}
                    <div class="totals-row total">
                        <span>${includeGST ? 'Total (incl. GST):' : 'Total:'}</span>
                        <span>$${total.toFixed(2)}</span>
                    </div>
                </div>

                <div class="bank-details">
                    <div class="section-title">Payment Details</div>
                    <strong>Bank:</strong> ${trader.bankName}<br>
                    <strong>Account Name:</strong> ${trader.accountName}<br>
                    <strong>Account Number:</strong> ${trader.accountNumber}
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; font-size: 13px;">
                        <strong>Important:</strong> When making payment, please ensure the account name entered matches exactly: <strong>${trader.accountName}</strong>
                    </div>
                </div>
            `;

            document.getElementById('invoicePreview').innerHTML = invoiceHTML;
            document.getElementById('invoicePreview').classList.add('active');

            // Save last invoice number
            const numMatch = invoiceNumber.match(/\d+/);
            if (numMatch) {
                setCookie('nz_invoice_last_number', parseInt(numMatch[0]));
            }

            // Scroll to invoice
            document.getElementById('invoicePreview').scrollIntoView({ behavior: 'smooth' });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-NZ', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
        }

        function printInvoice() {
            const preview = document.getElementById('invoicePreview');
            if (!preview.classList.contains('active')) {
                alert('Please generate the invoice first');
                return;
            }
            window.print();
        }

        function resetForm() {
            if (confirm('Are you sure you want to reset the form? This will clear invoice details and items (but not saved trader/client information).')) {
                // Clear invoice items
                document.getElementById('invoiceItems').innerHTML = '';
                invoiceItemCount = 0;
                addInvoiceItem();

                // Reset invoice details
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('invoiceDate').value = today;
                document.getElementById('dueDate').value = '';
                document.getElementById('periodStart').value = '';
                document.getElementById('periodEnd').value = '';
                
                // Reset GST checkbox to checked (default)
                document.getElementById('includeGST').checked = true;

                // Generate next invoice number
                const lastInvoiceNum = getCookie('nz_invoice_last_number') || 0;
                document.getElementById('invoiceNumber').value = 'INV-' + String(parseInt(lastInvoiceNum) + 1).padStart(4, '0');

                // Clear client selection
                document.getElementById('clientSelect').value = '';

                // Hide invoice preview
                document.getElementById('invoicePreview').classList.remove('active');

                // Recalculate totals
                calculateTotals();
            }
        }

        // About Modal Functions
        function openAboutModal() {
            document.getElementById('aboutModal').classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeAboutModal() {
            document.getElementById('aboutModal').classList.remove('active');
            document.body.style.overflow = ''; // Restore scrolling
        }

        function closeAboutModalOnBackdrop(event) {
            if (event.target.id === 'aboutModal') {
                closeAboutModal();
            }
        }

        // Allow closing modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('aboutModal');
                if (modal.classList.contains('active')) {
                    closeAboutModal();
                }
            }
        });
    </script>
</body>
</html>
